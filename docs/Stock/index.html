<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8" />
    <title>JsStorage Example</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link href="../materialize/css/materialize.min.css" rel="stylesheet " type="text/css" />
    <script src="../scripts/jquery.js"></script>
    <script src="../materialize/js/materialize.min.js"></script>
    <script src="../scripts/jsvalidator.js"></script>
    <script src="../scripts/matdialog.min.js"></script>
    <link href="../Style/matdialog.min.css" rel="stylesheet" type="text/css" />
</head>

<body>
    <ul id="listCustomer" class="dropdown-content">
        <li><a href="../customer/add.html">Add</a></li>
        <li><a href="../customer/index.html">List</a></li>
    </ul>
    <ul id="listStock" class="dropdown-content">
        <li><a href="../stock/add.html">Add</a></li>
        <li><a href="../stock/index.html">List</a></li>
    </ul>
    <nav class="nav-extended">
        <div class="nav-wrapper">
            <ul id="nav-mobile" class="right">
                <li><a href="../index.html">Home</a></li>
                <li><a class="dropdown-button" href="#!" data-activates="listCustomer">Customer<i class="material-icons right">arrow_drop_down</i></a></li>
                <li class="active"><a class="dropdown-button" href="#!" data-activates="listStock">Stock<i class="material-icons right">arrow_drop_down</i></a></li>
            </ul>
            <div class="brand-logo center-align">
                <a href="#" title="Download MatDialog" class="logo">ShopDemo</a><br>
            </div>
        </div>
    </nav>
    <div class="row center-align">
        <div class="col s12 m8 l6 xl4 push-s0 push-m2 push-l3 push-xl4 right-alert">
            <table id="tblStock">
                <caption class="#bf360c deep-orange darken-4 color-white padding-10-px">Items In Store</caption>
                <thead>
                    <tr id="trSearch">
                        <th><input type="text" placeholder="Item Name"></th>
                        <th><input type="text" placeholder="Price"></th>
                        <th><input type="text" placeholder="Quantity"></th>
                        <th></th>
                        <th></th>
                    </tr>
                    <tr id="trHeading">
                        <th>Name</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
    <link href="../style/main.css" rel="stylesheet " type="text/css" />
    <script src="../Scripts/JsStorage.js"></script>
    <script src="../Scripts/DbStructure.js"></script>
    <script src="../Scripts/main.js"></script>
    <style>
        table {
            border: 1px solid black;
        }

        table tr td,
        th {
            border: 1px solid black;
            text-align: center;
            cursor: pointer;
        }

        #trSearch input {
            border: 1px solid #26a69a;
            margin: 0px;
            text-align: center;
            box-sizing: border-box;
        }
    </style>
    <script>
        var WhereLogic = {},
            WhereInLogic = [];
        window.onload = function () {
            showStockItems();
            bindEvents();
        }

        function showStockItems() {
            Db.DbConnection.select({
                From: 'Stock'
            }, function (stocks) {
                createItemsList(stocks);
            }, function (error) {
                console.log(error);
                alert('Error Occured');
            })
        }

        function createItemsList(stocks) {
            var TableBody = document.querySelector('#tblStock tbody');
            TableBody.innerHTML = "";
            stocks.forEach(function (stock) {
                var Tr = document.createElement('tr');
                Tr.setAttribute('id', stock.ItemId);
                Tr.innerHTML = "<td>" + stock.ItemName + "</td><td>" + stock.Price + "</td><td>" +
                    stock.Quantity +
                    "</td><td class='edit'><i class='material-icons'>edit</i></td><td class='delete'><i class='material-icons'>delete</i></td>";
                TableBody.appendChild(Tr);
            });
        }

        function searchItems() {
            //if (Object.keys(WhereLogic).length > 0) {
            if (WhereInLogic.length > 0) {
                Db.DbConnection.select({
                    From: 'Stock',
                    // Where: WhereLogic
                    WhereIn: WhereInLogic
                }, function (stocks) {
                    createItemsList(stocks);
                }, function (error) {
                    console.log(error);
                    alert('Error Occured');
                })
            } else {
                showStockItems();
            }
        }

        function deleteItem(itemRow) {
            Db.DbConnection.delete({
                    From: 'stock',
                    Where: {
                        ItemId: Number(itemRow.attr('Id'))
                    }
                }, function (rowsAffected) {
                    if (rowsAffected > 0) {
                        itemRow.remove();
                    } else {
                        alert('No item deleted');
                    }
                },
                function (error) {
                    console.log(error);
                    alert('Error Occured')
                })

        }

        function sortItem(type, column) {
            Db.DbConnection.select({
                From: 'Stock',
                Order: {
                    By: column,
                    Type: type
                }
            }, function (stocks) {
                createItemsList(stocks);
            }, function (error) {
                console.log(error);
                alert('Error Occured');
            })
        }

        function bindEvents() {
            $('table#tblStock').on('click', 'tr td.delete', function () {
                var ItemRow = $(this).parent();
                deleteItem(ItemRow);
            })

            $('table#tblStock').on('click', 'tr td.edit', function () {
                window.location.href = "edit.html?id=" + $(this).parent().attr('Id');
            })
            $('#tblStock tr#trHeading th').click(function () {
                var Text = $(this).text();
                if (Text.length > 0) {
                    var SortType = $(this).attr('sortType');
                    if (SortType) {
                        $(this).attr('sortType', SortType == 'asc' ? 'desc' : 'asc')
                    } else {
                        SortType = 'asc';
                        $(this).attr('sortType', 'desc');
                    }
                    if (Text == 'Name') {
                        Text = 'ItemName';
                    }
                    sortItem(SortType, Text);
                }
            })
            $('#tblStock tr#trSearch th input').keyup(function () {
                var Value = $(this).val(),
                    Query = {
                        Column: null,
                        Value: null,
                        Op: null
                    };
                switch ($(this).parent().index()) {
                    case 0:
                        Query.Column = 'ItemName';
                        Query.Value = Value;
                        Query.Op = '~';
                        var ItemIndex = indexOfColumnInWhereInLogic(Query.Column);
                        //if value is not null and item does not exist
                        if (Value.length > 0 && ItemIndex < 0) {
                            WhereInLogic.push(Query)
                        } else if (Value.length == 0) { // item exist and value is null
                            deleteFromWhereIn(Query.Column);
                        } else { //item exist and value is updated
                            WhereInLogic[ItemIndex] = Query;
                        }
                        break;
                    case 1:
                        Query.Column = 'Price';
                        Query.Value = Number(Value);
                        Query.Op = '>=';
                        var ItemIndex = indexOfColumnInWhereInLogic(Query.Column);
                        if (Value.length > 0 && ItemIndex < 0) {
                            WhereInLogic.push(Query)
                        } else if (Value.length == 0) {
                            deleteFromWhereIn(Query.Column);
                        } else {
                            WhereInLogic[ItemIndex] = Query;
                        }
                        break;
                    case 2:
                        Query.Column = 'Quantity';
                        Query.Value = Number(Value);
                        Query.Op = '>=';
                        var ItemIndex = indexOfColumnInWhereInLogic(Query.Column);
                        if (Value.length > 0 && ItemIndex < 0) {
                            WhereInLogic.push(Query)
                        } else if (Value.length == 0) {
                            deleteFromWhereIn(Query.Column);
                        } else {
                            WhereInLogic[ItemIndex] = Query;
                        }
                        break;
                }
                searchItems();
            });

            function indexOfColumnInWhereInLogic(columnName) {
                var Index = -1;
                WhereInLogic.every(function (item, index) {
                    if (item.Column == columnName) {
                        Index = index;
                        return false;
                    }
                    return true;
                })
                return Index;
            }

            function deleteFromWhereIn(columnName) {
                WhereInLogic.splice(indexOfColumnInWhereInLogic(), 1);
            }
        }
    </script>
</body>

</html>