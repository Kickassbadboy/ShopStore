<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8" />
    <title>JsStorage Example</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link href="../materialize/css/materialize.min.css" rel="stylesheet " type="text/css" />
    <script src="../Scripts/jquery.js"></script>
    <script src="../materialize/js/materialize.min.js"></script>
    <link href="../Style/common.css" rel="stylesheet" type="text/css" />
</head>

<body>
    <ul id="listCustomer" class="dropdown-content">
        <li><a href="../customer/add.html">Add</a></li>
        <li><a href="../customer/index.html">List</a></li>
    </ul>
    <ul id="listStock" class="dropdown-content">
        <li><a href="../stock/add.html">Add</a></li>
        <li><a href="../stock/index.html">List</a></li>
    </ul>
    <ul id="listOrder" class="dropdown-content">
        <li><a href="Order/index.html">List</a></li>
    </ul>
    <nav class="nav-extended">
        <div class="nav-wrapper">
            <ul id="nav-mobile" class="right">
                <li><a href="../index.html">Home</a></li>
                <li><a class="dropdown-button" href="#!" data-activates="listCustomer">Customer<i class="material-icons right">arrow_drop_down</i></a></li>
                <li><a class="dropdown-button" href="#!" data-activates="listStock">Stock<i class="material-icons right">arrow_drop_down</i></a></li>
                <li class="active"><a class="dropdown-button" href="#!" data-activates="listOrder">Order<i class="material-icons right">arrow_drop_down</i></a></li>
            </ul>
            <div class="brand-logo center-align">
                <a href="#" title="Download MatDialog" class="logo">ShopDemo</a><br>
            </div>
        </div>
    </nav>
    <div class="row center-align">
        <div class="col s12 m8 l6 xl4 push-s0 push-m2 push-l3 push-xl4 right-alert">
            <table id="tblOrder">
                <caption class="#bf360c deep-orange darken-4 color-white padding-10-px">Items In Store</caption>
                <thead>
                    <tr id="trSearch">
                        <th><input type="text" placeholder="Receipt Id"></th>
                        <th><input type="text" placeholder="Customer Name"></th>
                        <th><input type="text" placeholder="Purchase Date"></th>
                        <th><input type="text" placeholder="Total"></th>
                        <th></th>
                    </tr>
                    <tr id="trHeading">
                        <th data-name="ReceiptId">Receipt Id</th>
                        <th data-name="CustomerName">Customer Name</th>
                        <th data-name="PurchaseDate">Purchase Date</th>
                        <th data-name="Total">Total</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
    <script src="../Scripts/matdialog.min-1.0.0.js"></script>
    <link href="../Style/matdialog.min-1.0.0.css" rel="stylesheet" type="text/css" />
    <script src="../Scripts/JsValidator.js"></script>
    <script src="../Scripts/JsStore-1.0.2.js"></script>
    <script src="../Scripts/DbStructure.js"></script>
    <script src="../Scripts/common.js"></script>
    <style>
        table {
            border: 1px solid black;
        }

        table tr td,
        th {
            border: 1px solid black;
            text-align: center;
            cursor: pointer;
        }

        #trSearch input {
            border: 1px solid #26a69a;
            margin: 0px;
            text-align: center;
            box-sizing: border-box;
        }
    </style>
    <script>
        var CustomerWhereInLogic,
            WhereInLogic = [];
        window.onload = function () {
            showOrderItems();
            bindEvents();
        }

        function showOrderItems() {
            var FromLogic = {
                Table1: {
                    Table: 'Receipt',
                    Column: 'CustomerId',
                    Order: {
                        By: 'PurchaseDate',
                        Type: 'desc'
                    }
                },
                Join: 'left',
                Table2: {
                    Table: 'Customer',
                    Column: 'CustomerId'
                }
            };

            Db.DbConnection.select({
                From: FromLogic
            }, function (stocks) {
                console.log(stocks);
                createItemsList(stocks);
            }, function (error) {
                console.log(error);
                alert('Error Occured');
            })
        }

        function createItemsList(orders) {
            var TableBody = document.querySelector('#tblOrder tbody');
            TableBody.innerHTML = "";
            orders.forEach(function (item) {
                if (item.Customer != null) {
                    var Customer = item.Customer,
                        Receipt = item.Receipt,
                        Pdate = Receipt.PurchaseDate,
                        Tr = document.createElement('tr');
                    Tr.innerHTML = "<td>" + Receipt.ReceiptId + "</td><td>" + Customer.CustomerName +
                        "</td><td>" +
                        Pdate.DD + "/" + (Pdate.MM) + "/" + Pdate.YY +
                        "</td><td>" + Receipt.Total +
                        "</td><td class='print'><i class='material-icons'>print</i></td>";
                    TableBody.appendChild(Tr);
                }
            });
        }

        function searchItems() {
            if (WhereInLogic.length > 0 || CustomerWhereInLogic) {
                var FromLogic = {
                    Table1: {
                        Table: 'Receipt',
                        Column: 'CustomerId',
                        Order: {
                            By: 'PurchaseDate',
                            Type: 'desc'
                        },
                        WhereIn: WhereInLogic
                    },
                    Join: 'left',
                    Table2: {
                        Table: 'Customer',
                        Column: 'CustomerId',
                        WhereIn: CustomerWhereInLogic
                    }
                };

                Db.DbConnection.select({
                    From: FromLogic
                }, function (stocks) {
                    createItemsList(stocks);
                }, function (error) {
                    console.log(error);
                    alert('Error Occured');
                })

            } else {
                showOrderItems();
            }
        }

        function sortItem(type, column) {
            Db.DbConnection.select({
                From: 'Stock',
                Order: {
                    By: column,
                    Type: type
                }
            }, function (stocks) {
                createItemsList(stocks);
            }, function (error) {
                console.log(error);
                alert('Error Occured');
            })
        }

        function bindEvents() {
            $('table#tblOrder').on('click', 'tr td.print', function () {
                window.location.href = "../print.html?receiptid=" + $(this).parent().find('td:first').text();
            })

            $('#tblOrder tr#trHeading th').click(function () {
                var Text = $(this).text();
                if (Text.length > 0) {
                    var SortType = $(this).attr('sortType');
                    if (SortType) {
                        $(this).attr('sortType', SortType == 'asc' ? 'desc' : 'asc')
                    } else {
                        SortType = 'asc';
                        $(this).attr('sortType', 'desc');
                    }
                    if (Text == 'Name') {
                        Text = 'ItemName';
                    }
                    sortItem(SortType, Text);
                }
            });

            $('#tblOrder tr#trSearch th input').keyup(function () {
                var Value = $(this).val(),
                    Query = {
                        Column: null,
                        Value: null,
                        Op: null
                    };
                CustomerWhereInLogic = null
                switch ($(this).parent().index()) {
                    case 0:
                        Query.Column = 'ReceiptId';
                        Query.Value = Number(Value);
                        Query.Op = '=';
                        var ItemIndex = indexOfColumnInWhereInLogic(Query.Column);
                        if (Value.length > 0 && ItemIndex < 0) {
                            WhereInLogic.push(Query)
                        } else if (Value.length == 0) {
                            deleteFromWhereIn(Query.Column);
                        } else {
                            WhereInLogic[ItemIndex] = Query;
                        }
                        break;
                    case 1:
                        CustomerWhereInLogic = {
                            Column: 'CustomerName',
                            Value: Value,
                            Op: '~'
                        }
                        break;

                    case 3:
                        Query.Column = 'Total';
                        Query.Value = Number(Value);
                        Query.Op = '>=';
                        var ItemIndex = indexOfColumnInWhereInLogic(Query.Column);
                        if (Value.length > 0 && ItemIndex < 0) {
                            WhereInLogic.push(Query)
                        } else if (Value.length == 0) {
                            deleteFromWhereIn(Query.Column);
                        } else {
                            WhereInLogic[ItemIndex] = Query;
                        }
                        break;
                }
                searchItems();
            });

            function indexOfColumnInWhereInLogic(columnName) {
                var Index = -1;
                WhereInLogic.every(function (item, index) {
                    if (item.Column == columnName) {
                        Index = index;
                        return false;
                    }
                    return true;
                })
                return Index;
            }

            function deleteFromWhereIn(columnName) {
                WhereInLogic.splice(indexOfColumnInWhereInLogic(), 1);
            }
        }
    </script>
</body>

</html>